# Resumo da Aula: Governança com IaC e Introdução ao Billing e Budget na AWS

## Introdução
Nesta aula, o professor reforça a importância do **Infra as Code (IaC)** para governança e gerenciamento de custos, abordando o cenário inverso de sincronizar infraestruturas legadas para arquivos declarativos. Ele introduz o conceito de **organização multi-account** para segregar custos por **Business Units (BUs)** e explora o **AWS Billing**, destacando ferramentas como o **AWS Cost Explorer** e **Budgets**. A aula enfatiza a configuração de alertas para monitoramento de custos e a facilidade do IaC para criar e destruir recursos, evitando custos recorrentes. A próxima aula focará na criação prática de um budget.

## Conteúdo Principal

### Reforço sobre Infra as Code (IaC)
- **Cenário Ideal**:
  - Recursos em cloud (ex.: EC2, EKS) são definidos em arquivos declarativos (ex.: Pulumi, Terraform), enviados a um repositório Git, revisados e aprovados via pipeline antes da criação.
  - Benefício: Garante governança, centralidade da informação e controle de custos, pois revisores podem avaliar o impacto financeiro (ex.: plugin na pipeline estima $73/mês para um cluster EKS).
- **Cenário Não Ideal**:
  - Escrever manifestos IaC sem revisão (ex.: aplicar diretamente sem PR) resolve apenas a centralidade, mas não evita custos inesperados, já que não há controle prévio.
- **Infraestruturas Legadas**:
  - Para infraestruturas existentes sem IaC, é possível fazer o **cenário inverso**:
    - Usar plugins ou ferramentas (ex.: `terraform import`, Pulumi export) para ler a infraestrutura atual e gerar arquivos declarativos.
    - Sincronizar a cloud com o código, centralizando a gestão no Git.
  - **Boa Prática**: Converter recursos gradativamente (ex.: por recurso, como um cluster EKS), testar com execuções locais (ex.: `pulumi up`) para evitar inconsistências, e aplicar a todas as clouds (AWS, GCP, Azure).
- **Vantagens do IaC**:
  - Facilita a criação e destruição de recursos via comandos (ex.: `pulumi up` para criar, `pulumi destroy` para remover), evitando custos de recursos ociosos (ex.: uma POC esquecida).
  - Centraliza a governança, com rastreabilidade de quem criou o recurso e por quê.

### Organização Multi-Account
- **Conceito**:
  - Dividir a infraestrutura em **contas separadas** na AWS (ou outras clouds) para cada **Business Unit (BU)** (ex.: BU de Pagamentos, BU de Checkout).
  - Exemplo: Conta mãe (organização) gerencia subcontas, cada uma representando uma BU com orçamentos próprios (ex.: BU1: $10.000/mês; BU2: $5.000/mês).
- **Benefícios**:
  - Separação clara de custos por BU, facilitando o monitoramento (ex.: BU1 gastou $10.000, BU2 gastou $5.000).
  - Maior controle para empresas com múltiplas equipes ou contextos.
  - Recursos compartilhados (ex.: um cluster EKS usado por 5 times) podem ter custos divididos proporcionalmente.
- **Exceções**:
  - Empresas pequenas podem usar uma única conta, mas o conceito multi-account é recomendado à medida que a organização cresce.
  - Recursos como filas (SQS) ou bancos podem ser alocados por BU, enquanto clusters EKS são compartilhados, com divisão de custos.

### AWS Billing e Cost Management
- **AWS Cost Explorer**:
  - Fornece um **sumário de gastos** na home da AWS, com detalhes por serviço (ex.: EC2: $1.35, EKS: $1.24, Cloud Computing: $0.44, taxas: $0.42, ECR: $0.04).
  - Exemplo: Em agosto 2025, o professor gastou $2.50, com previsão (*forecast*) de $2.52 até o final do mês, e uma queda de 30% em relação a julho 2025 ($3.58).
  - Comparações mensais ajudam a identificar tendências (ex.: redução de gastos).
- **Budgets**:
  - Ferramenta **AWS Budgets** permite definir orçamentos mensais (ex.: $20/mês) e configurar alertas para excesso.
  - Exemplo: Budget de $20/mês, com gasto atual de $2.50 (12% do budget). Alertas configurados para:
    - $17.50 (aviso prévio de possível excesso).
    - $20 (limite atingido).
  - Benefício: Receber notificações por e-mail quando o gasto se aproxima ou ultrapassa o limite, permitindo ações corretivas.
- **Monitoramento**:
  - O *forecast* estima gastos com base no uso diário (ex.: $1 no dia 1 projeta ~$30/mês, indicando possível excesso).
  - Comparações com meses anteriores (ex.: julho vs. agosto) ajudam a identificar padrões e otimizar.

### Governança e Custos
- **Evitar Recursos Ociosos**:
  - Recursos esquecidos (ex.: EC2 ou EKS criados para uma POC e não deletados) geram custos recorrentes (ex.: $100/mês inesperados).
  - Com IaC, a destruição é simples (ex.: `pulumi destroy`), eliminando recursos desnecessários rapidamente.
- **Importância dos Alertas**:
  - Configurar alertas no AWS Budgets é crucial para iniciantes e organizações, evitando surpresas no final do mês.
  - Exemplo: Um alerta em $17.50 sinaliza a necessidade de revisar recursos antes de atingir o limite de $20.
- **Governança Centralizada**:
  - IaC + multi-account garantem rastreabilidade e controle, com orçamentos claros por BU e alertas para desvios.

### Boas Práticas
- **IaC Obrigatório**: Sempre usar IaC para criar/destruir recursos, com revisões em pipelines Git para aprovações.
- **Conversão de Legado**: Para infraestruturas sem IaC, converter gradualmente usando plugins de sincronização, testando por recurso.
- **Multi-Account**: Adotar contas separadas por BU para segregação de custos, exceto em empresas muito pequenas.
- **Budgets e Alertas**: Configurar orçamentos no AWS Budgets com alertas para limites (ex.: 80-90% do budget) para agir proativamente.
- **Destruição de Recursos**: Usar IaC para remover recursos de POCs ou testes, evitando custos recorrentes.

### Próximos Passos
- Criar um budget prático no AWS Budgets na próxima aula, detalhando a configuração.
- Finalizar quaisquer tópicos pendentes sobre IaC.
- Continuar conectando governança e monitoramento de custos com práticas de DevOps.

## Conclusão
A aula reforça o **IaC** como essencial para governança e controle de custos, destacando a sincronização de infraestruturas legadas e a criação via pipelines com revisão. O conceito de **multi-account** facilita a segregação de custos por BU, enquanto o **AWS Billing** e **Budgets** oferecem monitoramento e alertas. A configuração de orçamentos e a destruição fácil de recursos via IaC evitam custos inesperados, preparando para a próxima aula, que focará na criação prática de budgets no contexto do stack de DevOps da Rocketseat.